<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="AI-powered image caption recommendation system with confidence scoring">
    <meta name="keywords" content="AI, image analysis, captions, machine learning">
    <title>AI Image Caption Recommendation System</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --warning-gradient: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
            --text-primary: #2d3748;
            --text-secondary: #718096;
            --shadow-soft: 0 10px 40px rgba(0, 0, 0, 0.1);
            --shadow-medium: 0 20px 60px rgba(0, 0, 0, 0.15);
            --border-radius: 20px;
            --transition-default: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --animation-bounce: cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            min-height: 100vh;
            color: var(--text-primary);
            overflow-x: hidden;
            line-height: 1.6;
        }

        /* Performance optimized particles */
        .bg-particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
            opacity: 0.6;
        }

        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            will-change: transform;
            animation: float 6s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { 
                transform: translateY(0px) rotate(0deg); 
                opacity: 0.3;
            }
            50% { 
                transform: translateY(-20px) rotate(180deg); 
                opacity: 0.8;
            }
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
            position: relative;
            z-index: 1;
        }

        /* Enhanced glassmorphism header */
        .header {
            text-align: center;
            margin-bottom: 3rem;
            backdrop-filter: blur(20px);
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius);
            padding: 2rem;
            box-shadow: var(--shadow-soft);
            transition: var(--transition-default);
        }

        .header:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        .header h1 {
            font-size: clamp(2rem, 5vw, 3rem);
            font-weight: 800;
            background: linear-gradient(135deg, #fff 0%, #f7fafc 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 1rem;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .header p {
            font-size: clamp(1rem, 2.5vw, 1.2rem);
            color: rgba(255, 255, 255, 0.9);
            max-width: 600px;
            margin: 0 auto;
        }

        /* Responsive grid system */
        .main-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 2rem;
            margin-bottom: 3rem;
        }

        /* Enhanced card components */
        .card {
            backdrop-filter: blur(20px);
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius);
            padding: 2rem;
            box-shadow: var(--shadow-medium);
            transition: var(--transition-default);
            will-change: transform;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.2);
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: white;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .section-title i {
            font-size: 1.25rem;
            opacity: 0.9;
        }

        /* Enhanced upload area */
        .upload-area {
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: var(--border-radius);
            padding: 3rem 2rem;
            text-align: center;
            cursor: pointer;
            transition: var(--transition-default);
            position: relative;
            overflow: hidden;
            background: rgba(255, 255, 255, 0.02);
        }

        .upload-area::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: left 0.6s ease;
        }

        .upload-area:hover::before {
            left: 100%;
        }

        .upload-area:hover {
            border-color: rgba(255, 255, 255, 0.6);
            background: rgba(255, 255, 255, 0.05);
            transform: scale(1.02);
        }

        .upload-area.dragover {
            border-color: #4facfe;
            background: rgba(79, 172, 254, 0.1);
            transform: scale(1.05);
            animation: pulse 0.6s ease-in-out;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1.05); }
            50% { transform: scale(1.08); }
        }

        .upload-icon {
            font-size: 3rem;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 1rem;
            transition: var(--transition-default);
        }

        .upload-area:hover .upload-icon {
            color: white;
            transform: scale(1.1) rotate(5deg);
        }

        .upload-text, .upload-subtext {
            color: rgba(255, 255, 255, 0.9);
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .upload-subtext {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.9rem;
            font-weight: 400;
        }

        #imageInput {
            position: absolute;
            opacity: 0;
            width: 0;
            height: 0;
        }

        /* Enhanced image preview */
        .image-preview {
            margin-top: 1.5rem;
            text-align: center;
            opacity: 0;
            transform: translateY(20px);
            transition: var(--transition-default);
        }

        .image-preview.show {
            opacity: 1;
            transform: translateY(0);
        }

        .preview-image {
            max-width: 100%;
            max-height: 300px;
            border-radius: 15px;
            box-shadow: var(--shadow-medium);
            border: 3px solid rgba(255, 255, 255, 0.2);
            transition: var(--transition-default);
        }

        .preview-image:hover {
            transform: scale(1.05);
        }

        /* Enhanced form inputs */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .input-field {
            width: 100%;
            padding: 1rem 1.25rem;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1rem;
            backdrop-filter: blur(10px);
            transition: var(--transition-default);
            font-family: inherit;
        }

        .input-field:focus {
            outline: none;
            border-color: #4facfe;
            background: rgba(255, 255, 255, 0.15);
            box-shadow: 0 0 20px rgba(79, 172, 254, 0.3);
            transform: translateY(-2px);
        }

        .input-field::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        /* Enhanced buttons */
        .btn {
            padding: 1rem 1.5rem;
            border: none;
            border-radius: 15px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition-default);
            font-family: inherit;
            position: relative;
            overflow: hidden;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            text-decoration: none;
            font-size: 1rem;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }

        .btn:hover:not(:disabled)::before {
            left: 100%;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: rgba(255, 255, 255, 0.1) !important;
        }

        .btn-primary {
            background: var(--primary-gradient);
            width: 100%;
            padding: 1.5rem;
            font-size: 1.2rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-primary:hover:not(:disabled) {
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: var(--success-gradient);
            width: 100%;
        }

        .btn-success:hover:not(:disabled) {
            box-shadow: 0 10px 30px rgba(79, 172, 254, 0.4);
        }

        .btn-danger {
            background: var(--secondary-gradient);
            padding: 0.5rem 0.75rem;
            font-size: 0.8rem;
            min-width: auto;
        }

        .btn-danger:hover {
            transform: scale(1.1);
        }

        /* Enhanced caption list */
        .caption-list {
            max-height: 250px;
            overflow-y: auto;
            margin-bottom: 1.5rem;
            padding-right: 0.5rem;
        }

        .caption-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.25rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            margin-bottom: 0.75rem;
            color: white;
            transition: var(--transition-default);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .caption-item:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateX(8px);
            border-color: rgba(255, 255, 255, 0.3);
        }

        .caption-text {
            flex: 1;
            font-weight: 500;
            margin-right: 1rem;
        }

        /* Enhanced loading animation */
        .loading {
            display: none;
            text-align: center;
            color: white;
            margin: 2rem 0;
            padding: 2rem;
        }

        .loading.show {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Enhanced results section */
        .results-section {
            opacity: 0;
            transform: translateY(30px);
            transition: all 0.6s var(--animation-bounce);
        }

        .results-section.show {
            opacity: 1;
            transform: translateY(0);
        }

        .results-grid {
            display: grid;
            gap: 1rem;
        }

        .result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: var(--transition-default);
            transform: translateX(-30px);
            opacity: 0;
        }

        .result-item.animate {
            transform: translateX(0);
            opacity: 1;
        }

        .result-item:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
        }

        .result-rank {
            font-size: 1.8rem;
            font-weight: 800;
            color: #4facfe;
            margin-right: 1.5rem;
            min-width: 50px;
            text-align: center;
        }

        .result-caption {
            flex: 1;
            color: white;
            font-size: 1.1rem;
            font-weight: 600;
            margin-right: 1rem;
        }

        .result-score {
            text-align: right;
            min-width: 120px;
        }

        .score-value {
            font-size: 1.3rem;
            font-weight: 700;
            color: white;
            margin-bottom: 0.5rem;
        }

        .confidence-bar {
            width: 100px;
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            overflow: hidden;
            margin: 0.5rem 0;
        }

        .confidence-fill {
            height: 100%;
            background: var(--success-gradient);
            border-radius: 4px;
            transition: width 1.5s var(--animation-bounce);
            width: 0%;
        }

        .confidence-indicator {
            font-size: 0.8rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.25rem;
        }

        /* Error handling */
        .error-message {
            background: linear-gradient(135deg, #ff6b6b, #ff5252);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 12px;
            margin: 1rem 0;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            animation: shake 0.5s ease-in-out;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        /* Success message */
        .success-message {
            background: var(--success-gradient);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 12px;
            margin: 1rem 0;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            animation: slideDown 0.5s ease;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Enhanced scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 4px;
            transition: var(--transition-default);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            
            .main-content {
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }
            
            .upload-area {
                padding: 2rem 1rem;
            }
            
            .card {
                padding: 1.5rem;
            }
            
            .result-item {
                flex-direction: column;
                text-align: center;
                gap: 1rem;
            }
            
            .result-rank {
                margin-right: 0;
            }
        }

        @media (max-width: 480px) {
            .header {
                padding: 1.5rem;
            }
            
            .btn-primary {
                font-size: 1rem;
                padding: 1.25rem;
            }
        }

        /* Accessibility improvements */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* Focus indicators */
        .btn:focus,
        .input-field:focus,
        .upload-area:focus-within {
            outline: 2px solid #4facfe;
            outline-offset: 2px;
        }

        /* High contrast mode support */
        @media (prefers-contrast: high) {
            :root {
                --glass-bg: rgba(0, 0, 0, 0.8);
                --glass-border: rgba(255, 255, 255, 0.8);
            }
        }

        /* Reduced motion support */
        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
    </style>
</head>
<body>
    <!-- Animated background particles -->
    <div class="bg-particles" aria-hidden="true"></div>

    <div class="container">
        <!-- Header -->
        <header class="header" role="banner">
            <h1>
                <i class="fas fa-brain" aria-hidden="true"></i> 
                AI Image Caption Recommendation
            </h1>
            <p>Upload your image and get AI-powered caption recommendations with confidence scores. Experience the future of image understanding.</p>
        </header>

        <!-- Main content -->
        <main class="main-content" role="main">
            <!-- Upload section -->
            <section class="card" aria-labelledby="upload-title">
                <h2 id="upload-title" class="section-title">
                    <i class="fas fa-cloud-upload-alt" aria-hidden="true"></i>
                    Upload Image
                </h2>
                
                <div class="upload-area" id="uploadArea" role="button" tabindex="0" aria-describedby="upload-instructions">
                    <i class="fas fa-image upload-icon" aria-hidden="true"></i>
                    <div class="upload-text">Drag & drop your image here</div>
                    <div class="upload-subtext" id="upload-instructions">or click to browse (JPG, PNG, WebP, up to 10MB)</div>
                    <input 
                        type="file" 
                        id="imageInput" 
                        accept="image/jpeg,image/jpg,image/png,image/webp,image/bmp"
                        aria-describedby="upload-instructions"
                    >
                </div>
                
                <div class="image-preview" id="imagePreview" role="img" aria-label="Uploaded image preview">
                    <img id="previewImage" class="preview-image" alt="Preview of uploaded image">
                </div>

                <!-- Messages container -->
                <div id="messagesContainer" aria-live="polite" aria-atomic="true"></div>
            </section>

            <!-- Captions section -->
            <section class="card" aria-labelledby="captions-title">
                <h2 id="captions-title" class="section-title">
                    <i class="fas fa-list-alt" aria-hidden="true"></i>
                    Candidate Captions
                </h2>
                
                <form class="form-group" id="captionForm">
                    <label for="captionInput" class="sr-only">Enter caption text</label>
                    <input 
                        type="text" 
                        id="captionInput" 
                        class="input-field" 
                        placeholder="Enter a caption option..." 
                        maxlength="100"
                        autocomplete="off"
                        aria-describedby="caption-help"
                    >
                    <div id="caption-help" class="sr-only">Maximum 100 characters, up to 20 captions allowed</div>
                    <button type="submit" class="btn btn-success" id="addCaptionBtn">
                        <i class="fas fa-plus" aria-hidden="true"></i> 
                        Add Caption
                    </button>
                </form>
                
                <div class="caption-list" id="captionList" role="list" aria-label="List of caption options">
                    <!-- Captions will be populated here -->
                </div>
                
                <button id="analyzeBtn" class="btn btn-primary" disabled aria-describedby="analyze-help">
                    <i class="fas fa-magic" aria-hidden="true"></i>
                    Analyze & Recommend
                </button>
                <div id="analyze-help" class="sr-only">Requires both an uploaded image and at least one caption</div>
            </section>
        </main>

        <!-- Loading animation -->
        <div class="loading" id="loading" role="status" aria-live="polite">
            <div class="spinner" aria-hidden="true"></div>
            <p>AI is analyzing your image and matching captions...</p>
        </div>

        <!-- Results section -->
        <section class="card results-section" id="resultsSection" aria-labelledby="results-title">
            <h2 id="results-title" class="section-title">
                <i class="fas fa-trophy" aria-hidden="true"></i>
                Top Recommendations
            </h2>
            <div class="results-grid" id="resultsGrid" role="list" aria-label="Recommended captions ranked by relevance">
                <!-- Results will be populated here -->
            </div>
        </section>
    </div>

    <script>
        /**
         * AI Image Caption Recommendation System
         * Industry-grade implementation with comprehensive error handling,
         * accessibility, and performance optimizations
         */
        class ImageCaptionApp {
            // Configuration constants
            static CONFIG = {
                MAX_FILE_SIZE: 10 * 1024 * 1024, // 10MB
                MAX_CAPTIONS: 20,
                MAX_CAPTION_LENGTH: 100,
                SUPPORTED_TYPES: ['image/jpeg', 'image/jpg', 'image/png', 'image/webp', 'image/bmp'],
                ANALYSIS_TIMEOUT: 30000, // 30 seconds
                PARTICLE_COUNT: 50,
                ANIMATION_DELAYS: {
                    RESULT_ITEM: 200,
                    RESULTS_SECTION: 500
                }
            };

            // Application state
            #state = {
                uploadedImage: null,
                captions: [],
                isAnalyzing: false,
                analysisController: null
            };

            // DOM element references
            #elements = {};

            constructor() {
                this.#initializeApp();
            }

            /**
             * Initialize the application
             */
            async #initializeApp() {
                try {
                    this.#cacheElements();
                    this.#bindEvents();
                    this.#createBackgroundParticles();
                    await this.#loadDefaultCaptions();
                    this.#updateAnalyzeButton();
                    
                    console.log('AI Image Caption App initialized successfully');
                } catch (error) {
                    this.#handleError('Failed to initialize application', error);
                }
            }

            /**
             * Cache DOM elements for performance
             */
            #cacheElements() {
                const elementIds = [
                    'uploadArea', 'imageInput', 'imagePreview', 'previewImage',
                    'captionForm', 'captionInput', 'addCaptionBtn', 'captionList',
                    'analyzeBtn', 'loading', 'resultsSection', 'resultsGrid',
                    'messagesContainer'
                ];

                elementIds.forEach(id => {
                    const element = document.getElementById(id);
                    if (!element) {
                        throw new Error(`Required element with ID '${id}' not found`);
                    }
                    this.#elements[id] = element;
                });
            }

            /**
             * Bind event listeners with proper error handling
             */
            #bindEvents() {
                try {
                    // File upload events
                    this.#elements.uploadArea.addEventListener('click', () => this.#elements.imageInput.click());
                    this.#elements.uploadArea.addEventListener('keydown', this.#handleUploadKeydown.bind(this));
                    this.#elements.uploadArea.addEventListener('dragover', this.#handleDragOver.bind(this));
                    this.#elements.uploadArea.addEventListener('dragleave', this.#handleDragLeave.bind(this));
                    this.#elements.uploadArea.addEventListener('drop', this.#handleDrop.bind(this));
                    this.#elements.imageInput.addEventListener('change', this.#handleFileSelect.bind(this));

                    // Caption form events
                    this.#elements.captionForm.addEventListener('submit', this.#handleCaptionSubmit.bind(this));
                    this.#elements.captionInput.addEventListener('input', this.#handleCaptionInput.bind(this));

                    // Analyze button
                    this.#elements.analyzeBtn.addEventListener('click', this.#handleAnalyzeClick.bind(this));

                    // Global error handler
                    window.addEventListener('error', this.#handleGlobalError.bind(this));
                    window.addEventListener('unhandledrejection', this.#handleUnhandledRejection.bind(this));
                } catch (error) {
                    this.#handleError('Failed to bind events', error);
                }
            }

            /**
             * Create optimized background particles
             */
            #createBackgroundParticles() {
                try {
                    const particlesContainer = document.querySelector('.bg-particles');
                    if (!particlesContainer) return;

                    const fragment = document.createDocumentFragment();
                    
                    for (let i = 0; i < ImageCaptionApp.CONFIG.PARTICLE_COUNT; i++) {
                        const particle = document.createElement('div');
                        particle.className = 'particle';
                        particle.style.cssText = `
                            left: ${Math.random() * 100}%;
                            top: ${Math.random() * 100}%;
                            animation-delay: ${Math.random() * 6}s;
                            animation-duration: ${Math.random() * 3 + 3}s;
                        `;
                        fragment.appendChild(particle);
                    }
                    
                    particlesContainer.appendChild(fragment);
                } catch (error) {
                    console.warn('Failed to create background particles:', error);
                }
            }

            /**
             * Load default captions asynchronously
             */
            async #loadDefaultCaptions() {
                const defaultCaptions = [
                    "Trees, Travel and Tea!",
                    "A refreshing beverage.",
                    "A moment of indulgence.",
                    "The perfect thirst quencher.",
                    "Your daily dose of delight.",
                    "Taste the tradition.",
                    "Savor the flavor.",
                    "Refresh and rejuvenate.",
                    "Unwind and enjoy."
                ];

                try {
                    // Simulate async loading with validation
                    await new Promise(resolve => setTimeout(resolve, 100));
                    
                    defaultCaptions.forEach(caption => {
                        if (this.#validateCaption(caption)) {
                            this.#state.captions.push(caption);
                        }
                    });
                    
                    this.#updateCaptionList();
                } catch (error) {
                    this.#handleError('Failed to load default captions', error);
                }
            }

            /**
             * Handle keyboard navigation for upload area
             */
            #handleUploadKeydown(event) {
                if (event.key === 'Enter' || event.key === ' ') {
                    event.preventDefault();
                    this.#elements.imageInput.click();
                }
            }

            /**
             * Handle drag over with proper prevention
             */
            #handleDragOver(event) {
                event.preventDefault();
                event.stopPropagation();
                event.currentTarget.classList.add('dragover');
            }

            /**
             * Handle drag leave
             */
            #handleDragLeave(event) {
                event.preventDefault();
                event.stopPropagation();
                event.currentTarget.classList.remove('dragover');
            }

            /**
             * Handle file drop with comprehensive validation
             */
            #handleDrop(event) {
                event.preventDefault();
                event.stopPropagation();
                event.currentTarget.classList.remove('dragover');
                
                try {
                    const files = event.dataTransfer.files;
                    if (files.length > 0) {
                        this.#processFile(files[0]);
                    }
                } catch (error) {
                    this.#handleError('Failed to process dropped file', error);
                }
            }

            /**
             * Handle file selection
             */
            #handleFileSelect(event) {
                try {
                    const file = event.target.files[0];
                    if (file) {
                        this.#processFile(file);
                    }
                } catch (error) {
                    this.#handleError('Failed to process selected file', error);
                }
            }

            /**
             * Handle caption form submission
             */
            #handleCaptionSubmit(event) {
                event.preventDefault();
                this.#addCaption();
            }

            /**
             * Handle caption input changes
             */
            #handleCaptionInput(event) {
                const input = event.target;
                const remainingChars = ImageCaptionApp.CONFIG.MAX_CAPTION_LENGTH - input.value.length;
                
                // Update character counter (could be added to UI)
                input.setAttribute('data-remaining', remainingChars);
            }

            /**
             * Handle analyze button click
             */
            async #handleAnalyzeClick(event) {
                event.preventDefault();
                await this.#analyzeImage();
            }

            /**
             * Process uploaded file with comprehensive validation
             */
            async #processFile(file) {
                try {
                    // Clear previous messages
                    this.#clearMessages();

                    // Validate file type
                    if (!ImageCaptionApp.CONFIG.SUPPORTED_TYPES.includes(file.type)) {
                        throw new Error(`Unsupported file type. Please select: ${ImageCaptionApp.CONFIG.SUPPORTED_TYPES.join(', ')}`);
                    }

                    // Validate file size
                    if (file.size > ImageCaptionApp.CONFIG.MAX_FILE_SIZE) {
                        throw new Error(`File size must be less than ${this.#formatFileSize(ImageCaptionApp.CONFIG.MAX_FILE_SIZE)}`);
                    }

                    // Validate file integrity
                    await this.#validateImageFile(file);

                    this.#state.uploadedImage = file;
                    await this.#showImagePreview(file);
                    this.#updateAnalyzeButton();
                    this.#showSuccessMessage('Image uploaded successfully!');

                } catch (error) {
                    this.#handleError('Failed to process image', error);
                    this.#elements.imageInput.value = ''; // Reset input
                }
            }

            /**
             * Validate image file integrity
             */
            async #validateImageFile(file) {
                return new Promise((resolve, reject) => {
                    const img = new Image();
                    const url = URL.createObjectURL(file);
                    
                    img.onload = () => {
                        URL.revokeObjectURL(url);
                        if (img.width === 0 || img.height === 0) {
                            reject(new Error('Invalid image file'));
                        } else {
                            resolve();
                        }
                    };
                    
                    img.onerror = () => {
                        URL.revokeObjectURL(url);
                        reject(new Error('Corrupted image file'));
                    };
                    
                    img.src = url;
                });
            }

            /**
             * Show image preview with error handling
             */
            async #showImagePreview(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    
                    reader.onload = (event) => {
                        try {
                            this.#elements.previewImage.src = event.target.result;
                            this.#elements.previewImage.alt = `Preview of ${file.name}`;
                            this.#elements.imagePreview.classList.add('show');
                            resolve();
                        } catch (error) {
                            reject(error);
                        }
                    };
                    
                    reader.onerror = () => {
                        reject(new Error('Failed to read image file'));
                    };
                    
                    reader.readAsDataURL(file);
                });
            }

            /**
             * Add caption with validation
             */
            #addCaption() {
                try {
                    const input = this.#elements.captionInput;
                    const caption = input.value.trim();
                    
                    // Validate caption
                    if (!this.#validateCaption(caption)) {
                        return;
                    }

                    // Check for duplicates
                    if (this.#state.captions.includes(caption)) {
                        this.#showErrorMessage('This caption already exists');
                        return;
                    }

                    // Check caption limit
                    if (this.#state.captions.length >= ImageCaptionApp.CONFIG.MAX_CAPTIONS) {
                        this.#showErrorMessage(`Maximum ${ImageCaptionApp.CONFIG.MAX_CAPTIONS} captions allowed`);
                        return;
                    }

                    // Add caption
                    this.#state.captions.push(caption);
                    input.value = '';
                    this.#updateCaptionList();
                    this.#updateAnalyzeButton();
                    
                    // Focus back to input for better UX
                    input.focus();

                } catch (error) {
                    this.#handleError('Failed to add caption', error);
                }
            }

            /**
             * Validate caption input
             */
            #validateCaption(caption) {
                if (!caption) {
                    this.#showErrorMessage('Please enter a caption');
                    return false;
                }

                if (caption.length > ImageCaptionApp.CONFIG.MAX_CAPTION_LENGTH) {
                    this.#showErrorMessage(`Caption must be less than ${ImageCaptionApp.CONFIG.MAX_CAPTION_LENGTH} characters`);
                    return false;
                }

                // Basic content validation
                if (caption.length < 3) {
                    this.#showErrorMessage('Caption must be at least 3 characters long');
                    return false;
                }

                return true;
            }

            /**
             * Remove caption at specified index
             */
            #removeCaption(index) {
                try {
                    if (index < 0 || index >= this.#state.captions.length) {
                        throw new Error('Invalid caption index');
                    }

                    this.#state.captions.splice(index, 1);
                    this.#updateCaptionList();
                    this.#updateAnalyzeButton();
                } catch (error) {
                    this.#handleError('Failed to remove caption', error);
                }
            }

            /**
             * Update caption list display
             */
            #updateCaptionList() {
                try {
                    const container = this.#elements.captionList;
                    container.innerHTML = '';

                    if (this.#state.captions.length === 0) {
                        const emptyMessage = document.createElement('div');
                        emptyMessage.className = 'caption-item';
                        emptyMessage.innerHTML = '<span style="opacity: 0.7; font-style: italic;">No captions added yet</span>';
                        container.appendChild(emptyMessage);
                        return;
                    }

                    const fragment = document.createDocumentFragment();

                    this.#state.captions.forEach((caption, index) => {
                        const captionItem = document.createElement('div');
                        captionItem.className = 'caption-item';
                        captionItem.setAttribute('role', 'listitem');
                        
                        captionItem.innerHTML = `
                            <span class="caption-text">${this.#escapeHtml(caption)}</span>
                            <button class="btn btn-danger" 
                                    onclick="app.removeCaption(${index})"
                                    aria-label="Remove caption: ${this.#escapeHtml(caption)}">
                                <i class="fas fa-times" aria-hidden="true"></i>
                            </button>
                        `;
                        
                        fragment.appendChild(captionItem);
                    });

                    container.appendChild(fragment);
                } catch (error) {
                    this.#handleError('Failed to update caption list', error);
                }
            }

            /**
             * Update analyze button state
             */
            #updateAnalyzeButton() {
                const hasImage = this.#state.uploadedImage !== null;
                const hasCaptions = this.#state.captions.length > 0;
                const isAnalyzing = this.#state.isAnalyzing;
                
                this.#elements.analyzeBtn.disabled = !(hasImage && hasCaptions) || isAnalyzing;
                
                if (isAnalyzing) {
                    this.#elements.analyzeBtn.innerHTML = `
                        <i class="fas fa-spinner fa-spin" aria-hidden="true"></i>
                        Analyzing...
                    `;
                } else {
                    this.#elements.analyzeBtn.innerHTML = `
                        <i class="fas fa-magic" aria-hidden="true"></i>
                        Analyze & Recommend
                    `;
                }
            }

            /**
             * Analyze image with comprehensive error handling
             */
            async #analyzeImage() {
                if (!this.#state.uploadedImage || this.#state.captions.length === 0) {
                    this.#showErrorMessage('Please upload an image and add at least one caption');
                    return;
                }

                if (this.#state.isAnalyzing) {
                    return; // Prevent multiple simultaneous analyses
                }

                try {
                    this.#state.isAnalyzing = true;
                    this.#state.analysisController = new AbortController();
                    
                    this.#showLoading(true);
                    this.#hideResults();
                    this.#updateAnalyzeButton();
                    this.#clearMessages();

                    // Simulate API call with timeout
                    const results = await this.#performAnalysis();
                    
                    if (results && results.length > 0) {
                        await this.#showResults(results);
                        this.#showSuccessMessage('Analysis completed successfully!');
                    } else {
                        throw new Error('No results returned from analysis');
                    }

                } catch (error) {
                    if (error.name === 'AbortError') {
                        this.#showErrorMessage('Analysis was cancelled');
                    } else {
                        this.#handleError('Analysis failed', error);
                    }
                } finally {
                    this.#state.isAnalyzing = false;
                    this.#state.analysisController = null;
                    this.#showLoading(false);
                    this.#updateAnalyzeButton();
                }
            }

            /**
             * Perform the actual analysis (simulated)
             */
            async #performAnalysis() {
                return new Promise((resolve, reject) => {
                    const timeout = setTimeout(() => {
                        reject(new Error('Analysis timed out'));
                    }, ImageCaptionApp.CONFIG.ANALYSIS_TIMEOUT);

                    // Simulate analysis processing
                    setTimeout(() => {
                        try {
                            if (this.#state.analysisController?.signal.aborted) {
                                clearTimeout(timeout);
                                reject(new Error('Analysis aborted'));
                                return;
                            }

                            // Generate mock similarity scores with more realistic distribution
                            const results = this.#state.captions.map(caption => ({
                                caption: caption,
                                similarity: this.#generateRealisticScore(),
                                confidence: Math.random() * 0.3 + 0.7 // 0.7-1.0
                            }));

                            // Sort by similarity score (descending)
                            results.sort((a, b) => b.similarity - a.similarity);

                            // Return top 5 results
                            const topResults = results.slice(0, Math.min(5, results.length));
                            
                            clearTimeout(timeout);
                            resolve(topResults);
                        } catch (error) {
                            clearTimeout(timeout);
                            reject(error);
                        }
                    }, 2000 + Math.random() * 2000); // 2-4 second simulation
                });
            }

            /**
             * Generate realistic similarity scores
             */
            #generateRealisticScore() {
                // More realistic score distribution
                const rand1 = Math.random();
                const rand2 = Math.random();
                
                // Use beta distribution-like approach for more realistic scores
                const score = Math.pow(rand1, 2) * rand2 * 0.4 + 0.6; // Range: 0.6-1.0
                return Math.min(1.0, Math.max(0.6, score));
            }

            /**
             * Show loading state
             */
            #showLoading(show) {
                this.#elements.loading.classList.toggle('show', show);
                
                if (show) {
                    this.#elements.loading.scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'center' 
                    });
                }
            }

            /**
             * Hide results section
             */
            #hideResults() {
                this.#elements.resultsSection.classList.remove('show');
            }

            /**
             * Show results with animations
             */
            async #showResults(results) {
                try {
                    const resultsGrid = this.#elements.resultsGrid;
                    resultsGrid.innerHTML = '';

                    if (!results || results.length === 0) {
                        throw new Error('No results to display');
                    }

                    const fragment = document.createDocumentFragment();

                    results.forEach((result, index) => {
                        const resultItem = this.#createResultItem(result, index);
                        fragment.appendChild(resultItem);
                    });

                    resultsGrid.appendChild(fragment);

                    // Show results section with delay
                    await new Promise(resolve => {
                        setTimeout(() => {
                            this.#elements.resultsSection.classList.add('show');
                            resolve();
                        }, ImageCaptionApp.CONFIG.ANIMATION_DELAYS.RESULTS_SECTION);
                    });

                    // Animate individual items
                    const items = resultsGrid.querySelectorAll('.result-item');
                    items.forEach((item, index) => {
                        setTimeout(() => {
                            item.classList.add('animate');
                            
                            // Animate confidence bar
                            const confidenceFill = item.querySelector('.confidence-fill');
                            if (confidenceFill) {
                                const percentage = confidenceFill.dataset.percentage;
                                confidenceFill.style.width = `${percentage}%`;
                            }
                        }, index * ImageCaptionApp.CONFIG.ANIMATION_DELAYS.RESULT_ITEM);
                    });

                    // Scroll to results
                    this.#elements.resultsSection.scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'start' 
                    });

                } catch (error) {
                    this.#handleError('Failed to display results', error);
                }
            }

            /**
             * Create individual result item
             */
            #createResultItem(result, index) {
                const resultItem = document.createElement('div');
                resultItem.className = 'result-item';
                resultItem.setAttribute('role', 'listitem');
                
                const confidence = this.#getConfidenceLevel(result.similarity);
                const percentage = (result.similarity * 100).toFixed(1);
                
                resultItem.innerHTML = `
                    <div class="result-rank">#${index + 1}</div>
                    <div class="result-caption">${this.#escapeHtml(result.caption)}</div>
                    <div class="result-score">
                        <div class="score-value">${percentage}%</div>
                        <div class="confidence-bar" role="progressbar" 
                             aria-valuenow="${percentage}" 
                             aria-valuemin="0" 
                             aria-valuemax="100"
                             aria-label="Confidence score">
                            <div class="confidence-fill" 
                                 data-percentage="${percentage}"></div>
                        </div>
                        <div class="confidence-indicator" style="color: ${confidence.color}">
                            <span aria-label="${confidence.label}">${confidence.icon}</span>
                            ${confidence.label}
                        </div>
                    </div>
                `;
                
                return resultItem;
            }

            /**
             * Get confidence level based on similarity score
             */
            #getConfidenceLevel(similarity) {
                if (similarity >= 0.95) {
                    return { label: 'EXCELLENT', color: '#4facfe', icon: '🔥' };
                } else if (similarity >= 0.85) {
                    return { label: 'VERY GOOD', color: '#43e97b', icon: '✅' };
                } else if (similarity >= 0.75) {
                    return { label: 'GOOD', color: '#f093fb', icon: '👍' };
                } else if (similarity >= 0.65) {
                    return { label: 'FAIR', color: '#feca57', icon: '⚠️' };
                } else {
                    return { label: 'POOR', color: '#ff6b6b', icon: '❌' };
                }
            }

            /**
             * Show success message
             */
            #showSuccessMessage(message) {
                this.#showMessage(message, 'success');
            }

            /**
             * Show error message
             */
            #showErrorMessage(message) {
                this.#showMessage(message, 'error');
            }

            /**
             * Show message with type
             */
            #showMessage(message, type = 'info') {
                try {
                    const container = this.#elements.messagesContainer;
                    
                    const messageEl = document.createElement('div');
                    messageEl.className = `${type}-message`;
                    messageEl.setAttribute('role', type === 'error' ? 'alert' : 'status');
                    
                    const icon = type === 'error' ? 'fa-exclamation-triangle' : 'fa-check-circle';
                    messageEl.innerHTML = `
                        <i class="fas ${icon}" aria-hidden="true"></i>
                        <span>${this.#escapeHtml(message)}</span>
                    `;
                    
                    container.appendChild(messageEl);
                    
                    // Auto-remove after 5 seconds
                    setTimeout(() => {
                        if (messageEl.parentNode) {
                            messageEl.remove();
                        }
                    }, 5000);
                    
                } catch (error) {
                    console.error('Failed to show message:', error);
                }
            }

            /**
             * Clear all messages
             */
            #clearMessages() {
                this.#elements.messagesContainer.innerHTML = '';
            }

            /**
             * Handle application errors
             */
            #handleError(message, error) {
                console.error(`${message}:`, error);
                this.#showErrorMessage(error.message || message);
            }

            /**
             * Handle global errors
             */
            #handleGlobalError(event) {
                console.error('Global error:', event.error);
                this.#showErrorMessage('An unexpected error occurred');
            }

            /**
             * Handle unhandled promise rejections
             */
            #handleUnhandledRejection(event) {
                console.error('Unhandled promise rejection:', event.reason);
                this.#showErrorMessage('An unexpected error occurred');
                event.preventDefault(); // Prevent default browser behavior
            }

            /**
             * Utility: Escape HTML to prevent XSS
             */
            #escapeHtml(text) {
                const map = {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#039;'
                };
                return text.replace(/[&<>"']/g, m => map[m]);
            }

            /**
             * Utility: Format file size
             */
            #formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }

            /**
             * Public method to remove caption (called from onclick)
             */
            removeCaption(index) {
                this.#removeCaption(index);
            }

            /**
             * Cleanup method for proper disposal
             */
            destroy() {
                try {
                    // Cancel ongoing analysis
                    if (this.#state.analysisController) {
                        this.#state.analysisController.abort();
                    }

                    // Clean up object URLs
                    if (this.#elements.previewImage.src.startsWith('blob:')) {
                        URL.revokeObjectURL(this.#elements.previewImage.src);
                    }

                    // Clear state
                    this.#state = {
                        uploadedImage: null,
                        captions: [],
                        isAnalyzing: false,
                        analysisController: null
                    };

                    console.log('AI Image Caption App destroyed successfully');
                } catch (error) {
                    console.error('Error during cleanup:', error);
                }
            }
        }

        // Initialize the application
        let app;
        
        // Wait for DOM to be fully loaded
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                app = new ImageCaptionApp();
            });
        } else {
            app = new ImageCaptionApp();
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (app && typeof app.destroy === 'function') {
                app.destroy();
            }
        });
    </script>
</body>
</html>